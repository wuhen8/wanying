
// src-tauri/src/lib.rs
#![cfg_attr(not(debug_assertions), windows_subsystem = "windows")]
// 1. *** æ·»åŠ æ‰€æœ‰éœ€è¦çš„ use è¯­å¥ ***
use std::collections::HashMap;
use base64::{Engine as _, engine::general_purpose};
use warp::{Filter, Reply}; // å…³é”®ï¼šå¯¼å…¥ Reply trait
#[tauri::command]
fn greet(name: &str) -> String {
format!("Hello, {}! You've been greeted from Rust!", name)
}
// å¯åŠ¨æœ¬åœ°ä»£ç†æœåŠ¡å™¨
async fn start_proxy_server() {
// å®šä¹‰ä»£ç†è·¯ç”±
let proxy_route = warp::path("proxy") // åŒ¹é… /proxy è·¯å¾„
.and(warp::query::<HashMap<String, String>>()) // æå–æ‰€æœ‰æŸ¥è¯¢å‚æ•°
.and(warp::header::optional::<String>("range")) // æå–å¯é€‰çš„ range å¤´
.and_then(handle_proxy_request); // äº¤ç»™å¤„ç†å‡½æ•°
println!("ğŸš€ ä»£ç†æœåŠ¡å™¨å¯åŠ¨åœ¨ http://127.0.0.1:7878");
warp::serve(proxy_route).run(([127, 0, 0, 1], 7878)).await;
}
// ä»£ç†è¯·æ±‚çš„å¤„ç†å‡½æ•°
async fn handle_proxy_request(
params: HashMap<String, String>,
range_header: Option<String>,
) -> Result<impl Reply, warp::Rejection> {
println!("ğŸ“¥ æ”¶åˆ°ä»£ç†è¯·æ±‚");
// è·å–å¹¶è§£ç  URL
let real_url = match params.get("url") {
    Some(encoded_url) => {
        match general_purpose::URL_SAFE_NO_PAD.decode(encoded_url.as_bytes()) {
            Ok(bytes) => String::from_utf8(bytes).map_err(|_| warp::reject())?,
            Err(_) => return Ok(warp::reply::with_status("Invalid Base64 URL", warp::http::StatusCode::BAD_REQUEST).into_response()),
        }
    },
    None => return Ok(warp::reply::with_status("Missing url parameter", warp::http::StatusCode::BAD_REQUEST).into_response()),
};

// è·å–å¹¶è§£ç  Cookie
let cookies = match params.get("cookie") {
    Some(encoded_cookie) => {
        match general_purpose::URL_SAFE_NO_PAD.decode(encoded_cookie.as_bytes()) {
            Ok(bytes) => String::from_utf8(bytes).unwrap_or_default(),
            Err(_) => String::new(),
        }
    },
    None => String::new(),
};

// åˆ›å»º reqwest å®¢æˆ·ç«¯
let client = reqwest::Client::new();
let mut req_builder = client
    .get(&real_url)
    .header("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) quark-cloud-drive/2.5.20 Chrome/100.0.4896.160 Electron/18.3.5.4-b478491100 Safari/537.36 Channel/pckk_other_ch")
    .header("Referer", "https://pan.quark.cn/")
    .header("Origin", "https://pan.quark.cn/"); // **å…³é”®ï¼šæ·»åŠ  Origin å¤´**

if !cookies.is_empty() {
    req_builder = req_builder.header("Cookie", &cookies);
}
if let Some(range) = range_header {
    req_builder = req_builder.header("Range", range);
}

println!("ğŸš€ å‘é€è¯·æ±‚è‡³: {}", real_url);


// *** 2. æ‰“å°å³å°†å‘é€åˆ°å¤¸å…‹æœåŠ¡å™¨çš„ Headers ***
//    æˆ‘ä»¬éœ€è¦å…‹éš† req_builder æ‰èƒ½åœ¨å‘é€å‰æ£€æŸ¥å®ƒ
if let Some(request_to_print) = req_builder.try_clone() {
    if let Ok(built_request) = request_to_print.build() {
        println!("  -> å³å°†å‘é€è‡³å¤¸å…‹çš„ Headers:");
        for (key, value) in built_request.headers().iter() {
            println!("     {}: {:?}", key, value);
        }
    }
}

// å‘é€è¯·æ±‚
match req_builder.send().await {
    Ok(response) => {
        let status = response.status();
        let mut reply_builder = warp::http::Response::builder().status(status);
        
        // è½¬å‘å“åº”å¤´
        for (name, value) in response.headers() {
            reply_builder = reply_builder.header(name.as_str(), value.as_bytes());
        }

        match response.bytes().await {
            Ok(bytes) => {
                println!("âœ… è¿”å›: {} bytes", bytes.len());
                Ok(reply_builder.body(bytes.to_vec()).unwrap().into_response())
            }
            Err(e) => {
                eprintln!("âŒ è¯»å–å“åº”ä½“å¤±è´¥: {}", e);
                Ok(warp::reply::with_status(e.to_string(), warp::http::StatusCode::INTERNAL_SERVER_ERROR).into_response())
            }
        }
    }
    Err(e) => {
        eprintln!("âŒ è¯·æ±‚å¤±è´¥: {}", e);
        Ok(warp::reply::with_status(e.to_string(), warp::http::StatusCode::INTERNAL_SERVER_ERROR).into_response())
    }
}
}
// æœ€ç»ˆçš„ run å‡½æ•°
#[cfg_attr(mobile, tauri::mobile_entry_point)]
pub fn run() {
// åœ¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹ä¸­ï¼Œä¸º tokio åˆ›å»ºä¸€ä¸ªè¿è¡Œæ—¶å¹¶å¯åŠ¨æœåŠ¡å™¨
std::thread::spawn(|| {
let rt = tokio::runtime::Builder::new_current_thread()
.enable_all()
.build()
.unwrap();
rt.block_on(start_proxy_server());
});
tauri::Builder::default()
    .plugin(tauri_plugin_http::init())
    .plugin(tauri_plugin_opener::init())
    .invoke_handler(tauri::generate_handler![greet])
    .run(tauri::generate_context!())
    .expect("error while running tauri application");
}
