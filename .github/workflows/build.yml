name: Build Tauri App

# 1. 何时触发工作流
on:
  # push:
  #   branches: [ "main", "master" ] # 当 main 或 master 分支有 push 时触发
  # pull_request:
  #   branches: [ "main", "master" ] # 当向 main 或 master 分支发起 PR 时触发
  workflow_dispatch: # 允许你手动在 GitHub Actions 页面触发

jobs:
  build-tauri:
    # 2. 矩阵策略：在不同操作系统上运行
    strategy:
      fail-fast: false
      matrix:
        platform: [ macos-latest, ubuntu-latest, windows-latest ]

    # 3. 指定运行环境
    runs-on: ${{ matrix.platform }}
    
    # 4. 运行步骤
    steps:
      # 步骤 1: 检出你的代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤 2: (可选) 如果你的前端使用 pnpm，需要安装它
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8 # 指定 pnpm 版本

      # 步骤 3: 设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18' # 推荐使用 LTS 版本
          cache: 'pnpm' # 使用 pnpm 缓存，如果是 npm/yarn，则改为 'npm' 或 'yarn'

      # 步骤 4: 核心步骤 - 使用官方 Tauri Action
      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # 必须提供，用于上传产物
        with:
          # Tauri Action 的参数
          tagName: app-v__VERSION__ # 上传 Release 时的标签名模板, __VERSION__ 会被替换为应用版本号
          releaseName: 'App v__VERSION__' # Release 的标题
          releaseBody: 'See the assets to download this version.' # Release 的描述
          releaseDraft: true # 创建为草稿 Release，你可以手动发布
          prerelease: false # 标记为预发布
          
      # 步骤 5: (可选，但推荐) 上传所有构建产物
      # 这会将所有平台的安装包（.dmg, .msi, .AppImage 等）都收集起来
      # 即使你不创建 Release，也可以在 Action 运行结果页面下载它们
      - name: Upload all artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-build-artifacts-${{ matrix.platform }}
          path: |
            src-tauri/target/release/bundle/
            !src-tauri/target/release/bundle/macos/*.app